<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login/Cadastro - Reusemi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/login.css}">
    <link rel="shortcut icon" th:href="@{/img/web/favicon-32x32.png}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<header>
    <div class="header-esquerda">
        <a th:href="@{/}"><img class="logo" th:src="@{/img/web/logo.png}" alt="logo"></a>

        <!-- Botão Hamburguer para Mobile -->
        <button class="menu-toggle" id="menuToggle">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <div class="search-container">
            <form action="/buscar" method="GET">
                <input class="pesquisar" type="search" name="q" placeholder="Pesquisar...">
                <button class="buscar" type="submit">Buscar</button>
            </form>
        </div>
    </div>

    <div class="header-group-links" id="headerLinks">
        <nav>
            <a class="header-link" th:href="@{/}">Início</a>
            <a class="header-link" th:href="@{/perfil}">Meus anúncios</a>

            <!-- CORREÇÃO: Usar sec:authorize em vez de th:if com isAuthenticated -->
            <a class="header-link" sec:authorize="isAnonymous()" th:href="@{/login}" style="color: #6bb422;">
                Login
            </a>
            <a class="header-link" sec:authorize="isAuthenticated()" th:href="@{/perfil}" style="color: #6bb422;">
                Meu Perfil
            </a>
        </nav>
        <a class="header-special" th:href="@{/products}">Anuncie Grátis</a>
    </div>
</header>

<div class="linha-fina"></div>

<!-- CORREÇÃO: Mostrar formulário apenas para usuários não autenticados -->
<div sec:authorize="isAnonymous()">
    <div class="login-container">
        <div class="login-banner">
            <h2>Faça parte da comunidade sustentável!</h2>
            <p>Junte-se a milhares de pessoas que estão economizando, ajudando o planeta e dando nova vida a produtos usados.</p>
            <div class="banner-icons">
                <div class="banner-icon">
                    <i class="fas fa-recycle"></i>
                    <span>Sustentabilidade</span>
                </div>
                <div class="banner-icon">
                    <i class="fas fa-handshake"></i>
                    <span>Trocas Seguras</span>
                </div>
                <div class="banner-icon">
                    <i class="fas fa-leaf"></i>
                    <span>Impacto Verde</span>
                </div>
            </div>
        </div>

        <div class="login-form-container">
            <div class="login-form">
                <h2>Entre na sua conta</h2>
                <p>Digite suas informações para acessar sua conta</p>

                <!-- FORMULÁRIO CORRIGIDO PARA SPRING SECURITY -->
                <form th:action="@{/login}" method="post">
                    <div class="form-group">
                        <label for="username">E-mail</label>
                        <input type="email" id="username" name="username" placeholder="seu@email.com" required>
                    </div>

                    <div class="form-group">
                        <label for="password">Senha</label>
                        <input type="password" id="password" name="password" placeholder="Sua senha" required>
                    </div>

                    <div class="form-options">
                        <div class="remember-me">
                            <input type="checkbox" id="remember-me" name="remember-me">
                            <label for="remember-me">Lembrar-me</label>
                        </div>
                        <a href="#" class="forgot-password">Esqueceu a senha?</a>
                    </div>

                    <!-- Mensagens de erro/sucesso -->
                    <div th:if="${param.error}" class="alert alert-danger mt-3">
                        <i class="fas fa-exclamation-circle"></i> E-mail ou senha inválidos!
                    </div>

                    <div th:if="${param.logout}" class="alert alert-success mt-3">
                        <i class="fas fa-check-circle"></i> Você foi desconectado com sucesso!
                    </div>

                    <div th:if="${sucesso}" class="alert alert-success mt-3">
                        <i class="fas fa-check-circle"></i> <span th:text="${sucesso}"></span>
                    </div>

                    <button type="submit" class="login-button">Entrar</button>
                </form>

                <div class="divider">
                    <span>Ou entre com</span>
                </div>

                <div class="social-login">
                    <div class="social-button">
                        <i class="fab fa-google" style="color: #DB4437;"></i>
                    </div>
                    <div class="social-button">
                        <i class="fab fa-facebook-f" style="color: #4267B2;"></i>
                    </div>
                    <div class="social-button">
                        <i class="fab fa-apple"></i>
                    </div>
                </div>

                <div class="signup-link">
                    Não tem uma conta? <a th:href="@{/cadastro}" id="signup-link">Cadastre-se agora</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CORREÇÃO: Mostrar mensagem para usuários já autenticados -->
<div sec:authorize="isAuthenticated()">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h3>Você já está logado!</h3>
                        <p>Olá, <span sec:authentication="name"></span>!</p>
                        <p>Você já possui uma sessão ativa.</p>
                        <div class="mt-4">
                            <a th:href="@{/products}" class="btn btn-success me-2">Ir para Produtos</a>
                            <a th:href="@{/logout}" class="btn btn-outline-secondary">Sair</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/index.js}"></script>
<script>
    console.log("Página de login carregada");

    // Debug do formulário
    document.querySelector('form')?.addEventListener('submit', function(e) {
        const email = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        console.log('Tentando login com:', { email, password });
    });
</script>
</body>
</html>